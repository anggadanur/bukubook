name: Run Tests

on: [push]

jobs:
    tests:
        name: phpstan
        runs-on: ubuntu-latest
        services:
          mysql:
           image: mysql:5.7
           env:
             MYSQL_ROOT_PASSWORD: password
             MYSQL_DATABASE: bukubook
           ports:
           - 33306:3306

        steps:
            - uses: actions/checkout@v2

            - name: setup php
              uses: shivammathur/setup-php@v2
              with:
                php-version: '8.1'
                coverage: none

            - name: Install composer dependencies
              run: composer install -n --prefer-dist

            - name: Run Statics Analysis
              run: ./vendor/bin/phpstan --error-format=github

            - name: Create env
              run: php -r "file_exists('.env') || copy('.env.ci', '.env');"

            - name: Generate env key
              run: php artisan key:generate

            - name: Create database
              run: |
                mkdir -p database
                touch database/database.sqlite

            - name: Migrate
              run: php artisan migrate --seed

            - name: Install front end
              run: |
               npm install
               npm run build

            - name: Feature Test
              run: php artisan test
              env:
                DB_CONNECTION: sqlite
                DB_DATABASE: database/database.sqlite
                run: php artisan test













